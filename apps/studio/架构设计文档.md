# @sker/studio 架构设计文档

基于 apps/studio/plan.md 的AI协作画布应用架构设计

## 🏗️ 目录结构设计

```
apps/studio/
├── public/                    # 静态资源
│   ├── icons/                # 图标资源
│   └── images/               # 图片资源
├── src/                      # 源代码目录
│   ├── components/           # 组件库
│   │   ├── canvas/          # 🎨 画布相关组件
│   │   │   ├── Canvas.tsx              # 主画布容器
│   │   │   ├── CanvasControls.tsx      # 缩放控制器
│   │   │   ├── CanvasNavigator.tsx     # 画布导航/缩略图
│   │   │   └── ViewModeToggle.tsx      # 显示模式切换
│   │   ├── node/            # 🧠 智能组件
│   │   │   ├── AINode.tsx              # AI组件基础类
│   │   │   ├── NodeEditor.tsx          # 组件编辑器
│   │   │   ├── NodeConnections.tsx     # 连接线管理
│   │   │   ├── NodeVersions.tsx        # 版本管理
│   │   │   └── NodeMetadata.tsx        # 元数据显示(标签/置信度)
│   │   ├── sidebar/         # 📱 MVP侧边栏
│   │   │   ├── Sidebar.tsx             # 侧边栏容器
│   │   │   ├── SearchBox.tsx           # 搜索组件
│   │   │   ├── CanvasStats.tsx         # 画布统计
│   │   │   └── ZoomIndicator.tsx       # 缩放指示器
│   │   ├── interactions/    # 🎯 交互组件
│   │   │   ├── ContextMenu.tsx         # 右键菜单
│   │   │   ├── DragHandler.tsx         # 拖拽处理
│   │   │   ├── SelectionBox.tsx        # 选择框
│   │   │   └── ShortcutHandler.tsx     # 快捷键处理
│   │   ├── ai/              # 💫 AI协作组件
│   │   │   ├── AIContentGenerator.tsx  # 内容生成
│   │   │   ├── AIProcessor.tsx         # 多输入处理
│   │   │   ├── ConfidenceIndicator.tsx # 置信度显示
│   │   │   └── LoadingStates.tsx       # AI处理状态
│   │   └── ui/              # 🎨 通用UI组件
│   │       ├── Button.tsx              # 按钮组件
│   │       ├── Modal.tsx               # 弹窗组件
│   │       ├── Toast.tsx               # 提示组件
│   │       └── Spinner.tsx             # 加载动画
│   ├── hooks/                # 自定义Hook
│   │   ├── useCanvas.ts                # 画布状态管理
│   │   ├── useAI.ts                    # AI交互逻辑
│   │   ├── useNodes.ts                 # 节点管理
│   │   ├── useSearch.ts                # 搜索功能
│   │   └── useShortcuts.ts             # 快捷键逻辑
│   ├── stores/               # 状态管理 (Zustand)
│   │   ├── canvasStore.ts              # 画布状态
│   │   ├── nodeStore.ts                # 节点状态
│   │   ├── aiStore.ts                  # AI状态
│   │   └── uiStore.ts                  # UI状态
│   ├── services/             # 业务服务层
│   │   ├── aiService.ts                # AI服务
│   │   ├── nodeService.ts              # 节点服务
│   │   ├── canvasService.ts            # 画布服务
│   │   └── websocketService.ts         # WebSocket服务
│   ├── utils/                # 工具函数
│   │   ├── canvas.ts                   # 画布工具函数
│   │   ├── node.ts                     # 节点工具函数
│   │   ├── ai.ts                       # AI工具函数
│   │   └── constants.ts                # 常量定义
│   ├── types/                # TypeScript类型定义
│   │   ├── canvas.ts                   # 画布类型
│   │   ├── node.ts                     # 节点类型
│   │   ├── ai.ts                       # AI类型
│   │   └── api.ts                      # API类型
│   ├── pages/                # 页面组件 (如果使用路由)
│   │   ├── CanvasPage.tsx              # 主画布页面
│   │   └── SettingsPage.tsx            # 设置页面
│   └── App.tsx               # 应用入口
├── package.json              # 依赖管理
└── README.md                # 项目说明
```

## 📱 页面功能与组件映射

### 🎨 主画布页面 (CanvasPage)

**核心功能**: 无限画布的AI协作创造工作区

**使用的主要组件**:
- `Canvas.tsx` - 画布容器，使用React Flow引擎
- `Sidebar.tsx` - MVP版本侧边栏
- `AINode.tsx` - 智能节点组件
- `ContextMenu.tsx` - 右键操作菜单
- `CanvasControls.tsx` - 缩放控制

**实现的功能**:
1. **双击创世** - 空白画布双击创建第一个AI组件
2. **拖拽扩展** - 连线到空白处自动生成新组件  
3. **多输入融合** - 空组件接收多个输入，AI融合生成综合内容
4. **实时AI处理** - WebSocket + RabbitMQ确保响应体验

**需要的工具库**:
- `react-flow-renderer` - 画布引擎
- `@tanstack/react-query` - API状态管理
- `ws` - WebSocket客户端
- `framer-motion` - 动画效果

**状态管理需求**:
- `canvasStore` - 画布视图状态(位置、缩放)
- `nodeStore` - 节点数据和状态
- `aiStore` - AI处理状态和结果

## 🧩 核心组件设计

### 1. 画布相关组件 (canvas/)

#### Canvas.tsx
**责任**: 主画布容器，管理节点渲染和交互
```typescript
interface CanvasProps {
  nodes: AINode[]
  edges: Edge[]
  onNodeCreate: (position: Position) => void
  onNodeConnect: (source: string, target: string) => void
}
```
**工具库**: react-flow-renderer, framer-motion
**状态管理**: canvasStore (视图状态), nodeStore (节点数据)

#### CanvasControls.tsx  
**责任**: 缩放控制、显示模式切换
```typescript
interface CanvasControlsProps {
  zoomLevel: number
  onZoomChange: (level: number) => void
  viewMode: 'preview' | 'detail'
  onViewModeChange: (mode: ViewMode) => void
}
```
**工具库**: 无特殊依赖
**状态管理**: canvasStore

### 2. 智能组件 (node/)

#### AINode.tsx
**责任**: AI节点的核心组件，处理内容显示和交互
```typescript
interface AINodeProps {
  id: string
  content: string
  confidence: number
  importance: 1 | 2 | 3 | 4 | 5
  status: 'idle' | 'processing' | 'completed' | 'error'
  onEdit: () => void
  onOptimize: () => void
}
```
**工具库**: react-markdown (内容渲染)
**状态管理**: nodeStore, aiStore

#### NodeEditor.tsx
**责任**: 节点内容编辑器
**工具库**: @monaco-editor/react (代码编辑器，如需要)
**状态管理**: nodeStore

### 3. 侧边栏组件 (sidebar/) - MVP极简版

#### Sidebar.tsx
**责任**: 侧边栏容器，只包含搜索和统计
```typescript
interface SidebarProps {
  searchQuery: string
  onSearchChange: (query: string) => void
  componentCount: number
  averageRating: number
}
```
**工具库**: 无特殊依赖
**状态管理**: uiStore (搜索状态)

### 4. AI协作组件 (ai/)

#### AIContentGenerator.tsx
**责任**: AI内容生成和管理
```typescript
interface AIContentGeneratorProps {
  inputs: string[]
  context?: string
  onGenerated: (content: string, confidence: number) => void
  onError: (error: Error) => void
}
```
**工具库**: @tanstack/react-query
**状态管理**: aiStore

## 🗂️ 状态管理架构

### canvasStore (Zustand)
```typescript
interface CanvasState {
  // 视图状态
  viewport: { x: number; y: number; zoom: number }
  viewMode: 'preview' | 'detail'
  
  // 搜索状态 (MVP)
  searchQuery: string
  filteredNodeIds: string[]
  
  // Actions
  setViewport: (viewport: Viewport) => void
  setViewMode: (mode: ViewMode) => void
  updateSearch: (query: string) => void
}
```

### nodeStore (Zustand)
```typescript
interface NodeState {
  // 节点数据
  nodes: Map<string, AINode>
  edges: Edge[]
  selectedNodeIds: string[]
  
  // 统计数据 (MVP)
  nodeCount: number
  averageImportance: number
  
  // Actions
  addNode: (node: AINode) => void
  updateNode: (id: string, updates: Partial<AINode>) => void
  deleteNode: (id: string) => void
  connectNodes: (sourceId: string, targetId: string) => void
}
```

### aiStore (Zustand)
```typescript
interface AIState {
  // AI处理状态
  processingNodes: Set<string>
  recentResults: Map<string, AIResult>
  
  // WebSocket状态
  connectionStatus: 'connected' | 'disconnected' | 'connecting'
  
  // Actions
  generateContent: (nodeId: string, inputs: string[]) => Promise<void>
  optimizeContent: (nodeId: string) => Promise<void>
}
```

## 📦 工具库依赖分析

### 核心依赖
- **react-flow-renderer** - 画布引擎，支持无限滚动和虚拟化
- **@tanstack/react-query** - API状态管理，处理AI服务调用
- **zustand** - 轻量级状态管理，管理画布和节点状态
- **tailwindcss** - 样式框架，快速构建UI
- **framer-motion** - 动画库，提升交互体验

### AI集成
- **ws** - WebSocket客户端，实时AI通信
- **react-markdown** - Markdown内容渲染
- **@types/uuid** - UUID生成，节点唯一标识

### MVP阶段暂不需要
- ❌ 复杂的图表库 (recharts) - 数据洞察功能延后
- ❌ 路由库 (react-router) - 单页面MVP
- ❌ 表单库 (react-hook-form) - 简化用户输入
- ❌ 主题库 (styled-components) - 使用TailwindCSS

## ⚡ 性能优化策略

### 1. React Flow优化
- 使用内置虚拟化，支持1000+节点
- 节点延迟加载，只渲染可视区域
- 连接线简化渲染，减少重绘

### 2. 状态管理优化
- Zustand按功能模块分割store
- 使用immer处理复杂状态更新
- AI结果缓存，避免重复计算

### 3. AI交互优化  
- WebSocket连接复用
- 请求队列管理，避免并发过载
- 增量更新，只传输变化部分

## 🚀 MVP开发优先级

### Week 1-2: 基础架构 ✅ 已完成
1. ✅ 搭建项目结构和基础组件
2. ✅ 集成React Flow画布
3. ✅ 实现基础的节点创建和连接

### Week 3: AI集成 ✅ 已完成
1. ✅ AI服务集成和WebSocket连接
2. ✅ 实现双击创建和拖拽扩展
3. ✅ 基础的内容生成功能

### Week 4: 交互完善 🔄 进行中
1. ⏳ 右键菜单和快捷键
2. ⏳ 搜索功能和基础统计
3. ⏳ 错误处理和用户反馈

## 📊 当前项目状态 (2025-09-29)

### ✅ 已实现功能
- **完整项目结构**: 按照架构设计搭建了完整的目录结构
- **React Flow画布引擎**: 集成React Flow，支持无限画布交互
- **AI服务层**: 完整的AIService类，支持内容生成、优化、融合等功能
- **WebSocket实时通信**: 完整的WebSocketService，支持断线重连和消息队列
- **组件体系**: Canvas、AINode、Sidebar等核心组件框架
- **状态管理**: Zustand stores架构(canvasStore、nodeStore、aiStore、uiStore)
- **类型系统**: 完整的TypeScript类型定义

### 🔄 开发中功能
- **UI组件完善**: Button、Modal、Toast等基础UI组件需要具体实现
- **交互逻辑**: 双击创建、拖拽扩展的具体交互逻辑
- **错误处理**: AI服务和WebSocket的错误恢复机制

### ⏳ 待开发功能
- **右键菜单系统**: 画布和节点的上下文菜单
- **搜索功能**: 节点内容搜索和筛选
- **快捷键系统**: 键盘交互支持
- **版本管理UI**: 节点版本历史的可视化界面

### 🎯 技术债务与优化
- **环境变量配置**: AI API和WebSocket URL需要配置
- **错误边界**: React错误边界组件
- **性能优化**: 大量节点时的虚拟化渲染
- **测试覆盖**: 单元测试和集成测试

## 🚧 下一阶段开发计划

### Phase 1: 核心交互完善 (1-2周)
1. **双击创建功能**: 空白画布双击创建AI节点
2. **拖拽扩展机制**: 连线到空白处自动创建新节点
3. **节点编辑器**: 内容编辑和版本管理
4. **基础右键菜单**: 创建、编辑、删除等操作

### Phase 2: AI协作增强 (2-3周)
1. **多输入融合**: 空节点接收多个输入源
2. **智能标题生成**: 自动为节点生成简洁标题
3. **置信度显示**: AI生成内容的可信度评分
4. **实时状态反馈**: 处理中、已完成等状态可视化

### Phase 3: 用户体验优化 (1-2周)
1. **搜索和筛选**: 按内容、标签、重要性筛选节点
2. **快捷键支持**: 提升操作效率
3. **错误处理**: 优雅的错误提示和恢复
4. **性能优化**: 大规模节点的流畅渲染

这个架构设计专注于MVP核心功能，目前已完成基础架构和服务层，正在进入交互完善阶段。