# @sker/studio 技术实施方案

> 基于代码分析和文档梳理的具体技术实施路线图 (2025-09-29)

## 📊 实施背景

**项目现状**: 75%完成度，服务层架构完备，UI集成是关键
**核心挑战**: Canvas事件与NodeService方法的集成
**目标**: 3周内完成MVP发布

## 🎯 实施优先级矩阵

### Phase 1: 核心交互集成 (Week 1 - 高优先级)
**目标**: 实现完整的AI协作流程

#### 1.1 Canvas双击创建功能 (2天)
**文件**: `apps/studio/src/components/canvas/Canvas.tsx:467-510`
**现状**: Canvas组件已实现，双击事件注册已有框架
**任务**: 连接NodeService.createNode()方法

```typescript
// 实施要点
const handleCanvasDoubleClick = useCallback(async (event: MouseEvent) => {
  const position = screenToFlowPosition({
    x: event.clientX,
    y: event.clientY,
  })

  // 调用NodeService.createNode()
  const node = await nodeService.createNode({
    position,
    useAI: true,
    content: "请输入您的想法..."
  })

  // 更新Canvas状态
  setNodes(prevNodes => [...prevNodes, NodeDataConverter.toReactFlow(node)])
}, [screenToFlowPosition, setNodes])
```

#### 1.2 拖拽扩展机制 (2天)
**文件**: `apps/studio/src/components/canvas/Canvas.tsx:512-554`
**现状**: 连线事件处理框架已有
**任务**: 集成NodeService.dragExpandGenerate()

```typescript
// 实施要点
const onConnectEnd = useCallback(async (event: MouseEvent, connectionState: ConnectionState) => {
  if (connectionState.isValid) return

  const targetPosition = screenToFlowPosition({
    x: event.clientX,
    y: event.clientY,
  })

  if (connectionState.fromNode) {
    // 调用拖拽扩展服务
    const sourceNode = nodes.find(n => n.id === connectionState.fromNode.nodeId)
    if (sourceNode) {
      const expandedNode = await nodeService.dragExpandGenerate(
        NodeDataConverter.fromReactFlow(sourceNode),
        targetPosition
      )
      setNodes(prev => [...prev, NodeDataConverter.toReactFlow(expandedNode)])
    }
  }
}, [screenToFlowPosition, nodes, setNodes])
```

#### 1.3 多输入融合UI (3天)
**文件**: 新建 `apps/studio/src/components/fusion/FusionPanel.tsx`
**现状**: NodeService.fusionGenerate()方法已完成
**任务**: 创建融合操作界面

```typescript
interface FusionPanelProps {
  selectedNodes: AINode[]
  position: Position
  onFusion: (result: AINode) => void
  onCancel: () => void
}

// 核心功能
// 1. 显示选中节点列表
// 2. 融合类型选择 (summary/synthesis/comparison)
// 3. 可选提示词输入
// 4. 调用NodeService.fusionGenerate()
// 5. 结果展示和确认
```

### Phase 2: 用户体验优化 (Week 2 - 中优先级)

#### 2.1 右键菜单功能实现 (2天)
**文件**: `apps/studio/src/components/canvas/ContextMenu.tsx:1-403`
**现状**: 菜单框架完成，功能项标记TODO
**任务**: 实现具体功能项

```typescript
// 待实现功能
const contextMenuActions = {
  editNode: (nodeId: string) => openNodeEditor(nodeId),
  optimizeContent: async (nodeId: string) => {
    const node = getNodeById(nodeId)
    const optimized = await nodeService.updateNode(nodeId, node, { useAI: true })
    updateNode(nodeId, optimized)
  },
  duplicateNode: (nodeId: string) => {
    const node = getNodeById(nodeId)
    const duplicated = nodeService.duplicateNode(node, getNewPosition())
    addNode(duplicated)
  },
  deleteNode: (nodeId: string) => removeNode(nodeId),
  setImportance: (nodeId: string, importance: 1|2|3|4|5) => {
    updateNode(nodeId, { importance })
  }
}
```

#### 2.2 NodeEditor完善 (3天)
**文件**: `apps/studio/src/components/editor/NodeEditor.tsx:1-610`
**现状**: 编辑器组件基础功能完成
**任务**: 集成AI优化和保存逻辑

```typescript
// 集成要点
const handleAIOptimize = async () => {
  setIsProcessing(true)
  try {
    const optimized = await nodeService.updateNode(nodeId, currentNode, {
      content: content,
      useAI: true
    })
    setContent(optimized.content || content)
    setConfidence(optimized.confidence || 0.5)
  } finally {
    setIsProcessing(false)
  }
}

const handleSave = async () => {
  const updates = await nodeService.updateNode(nodeId, currentNode, {
    content,
    title,
    importance,
    tags
  })
  onSave(updates)
  onClose()
}
```

#### 2.3 错误处理完善 (2天)
**文件**: 新建 `apps/studio/src/components/common/ErrorBoundary.tsx`
**任务**: 实现完整的错误边界和用户反馈

```typescript
// 错误处理策略
class ErrorBoundary extends React.Component {
  // 1. React错误边界
  // 2. AI服务错误处理
  // 3. WebSocket连接错误
  // 4. 用户友好的错误提示
  // 5. 错误恢复建议
}
```

### Phase 3: 质量保证 (Week 3 - 必要优先级)

#### 3.1 性能优化 (2天)
**重点**: 大规模节点场景优化

```typescript
// 优化策略
// 1. React.memo优化组件渲染
// 2. useCallback优化事件处理
// 3. useMemo优化计算密集操作
// 4. React Flow虚拟化配置
// 5. 状态更新batch处理
```

#### 3.2 测试覆盖 (2天)
**文件**: 新建 `apps/studio/src/tests/`

```typescript
// 测试重点
// 1. NodeService业务逻辑测试
// 2. Canvas交互测试
// 3. AI服务集成测试
// 4. 错误场景测试
// 5. 性能基准测试
```

#### 3.3 发布准备 (3天)
- 生产环境配置
- 部署脚本
- 监控日志
- 文档完善

## 🔧 技术实施细节

### 核心集成点

#### 1. Canvas事件系统
```typescript
// Canvas.tsx 关键修改点
import { nodeService } from '@/services/nodeService'
import { NodeDataConverter } from '@/types/converter'

// 双击创建
const handleCanvasDoubleClick = async (event: MouseEvent) => {
  // 实现细节...
}

// 拖拽扩展
const onConnectEnd = async (event: MouseEvent, connectionState: ConnectionState) => {
  // 实现细节...
}

// 多选融合
const handleMultiNodeFusion = async (selectedNodeIds: string[]) => {
  // 实现细节...
}
```

#### 2. 状态管理集成
```typescript
// stores/canvasStore.ts 扩展
interface CanvasStore {
  // 现有状态...

  // 新增AI协作状态
  isCreatingNode: boolean
  isExpandingNode: boolean
  isFusingNodes: boolean

  // 新增操作方法
  createNodeWithAI: (position: Position, options?: CreateNodeOptions) => Promise<void>
  expandNodeWithAI: (sourceId: string, targetPosition: Position) => Promise<void>
  fuseNodesWithAI: (nodeIds: string[], fusionType: FusionType) => Promise<void>
}
```

#### 3. 错误处理策略
```typescript
// 分层错误处理
// 1. 服务层: NodeService内部错误处理和降级
// 2. 组件层: ErrorBoundary捕获组件错误
// 3. 应用层: 全局错误监控和用户反馈
// 4. 网络层: WebSocket断线重连和消息重发
```

### 数据流架构

```
用户交互 → Canvas事件 → NodeService方法 → AI服务 → 状态更新 → UI反馈
    ↓
错误处理 → 降级策略 → 用户提示 → 操作建议
```

## 📅 实施时间表

### Week 1: 核心功能集成
- **Day 1-2**: Canvas双击创建集成
- **Day 3-4**: 拖拽扩展机制实现
- **Day 5-7**: 多输入融合UI开发

**里程碑**: 用户可以完整体验AI协作流程

### Week 2: 体验优化
- **Day 1-2**: 右键菜单功能实现
- **Day 3-5**: NodeEditor完善和集成
- **Day 6-7**: 错误处理系统

**里程碑**: 系统稳定运行，体验流畅

### Week 3: 质量保证
- **Day 1-2**: 性能优化
- **Day 3-4**: 测试覆盖
- **Day 5-7**: 发布准备

**里程碑**: MVP版本发布就绪

## 🎯 成功标准

### 功能完整性
- ✅ 双击创建AI节点功能正常
- ✅ 拖拽扩展生成相关节点
- ✅ 多输入融合生成综合内容
- ✅ 节点编辑和AI优化功能
- ✅ 右键菜单操作完整

### 技术质量
- ✅ TypeScript无编译错误
- ✅ 构建时间<10s
- ✅ 应用包大小<1MB
- ✅ 核心功能测试覆盖>80%

### 用户体验
- ✅ 界面响应<100ms
- ✅ 新用户上手<10分钟
- ✅ 错误恢复<30秒
- ✅ 整体满意度>4.0/5

## 📋 实施检查清单

### Phase 1 完成标准
- [ ] Canvas.tsx handleCanvasDoubleClick实现
- [ ] Canvas.tsx onConnectEnd集成NodeService
- [ ] FusionPanel组件创建并集成
- [ ] 端到端AI协作流程测试通过

### Phase 2 完成标准
- [ ] ContextMenu所有TODO功能项实现
- [ ] NodeEditor AI优化和保存功能
- [ ] ErrorBoundary错误处理机制
- [ ] 用户体验测试通过

### Phase 3 完成标准
- [ ] 性能基准测试达标
- [ ] 测试覆盖率>80%
- [ ] 生产环境部署成功
- [ ] MVP发布验收通过

## 🚀 风险控制

### 高风险项
1. **Canvas事件集成复杂度** - 预留缓冲时间，准备降级方案
2. **AI服务稳定性** - 实现完整错误处理和重试机制
3. **性能瓶颈** - 提前优化，建立性能监控

### 应对策略
- 每日进度检查，及时调整计划
- 关键功能优先，次要功能可推迟
- 保持技术债务控制，避免影响核心功能

---

**实施原则**: 稳定性优先，用户体验至上，技术债务可控
**目标**: 3周内交付可用的AI协作画布MVP版本